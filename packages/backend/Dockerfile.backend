FROM node:12-alpine

ARG GIT_COMMIT=""
LABEL GIT_COMMIT=${GIT_COMMIT}

RUN apk --no-cache update \
&& apk --no-cache add g++ make bash zlib-dev libpng-dev postgresql-client redis python2 \
&&  rm -fr /var/cache/apk/*

COPY --chown=node . /app

USER node

ENV NODE_ENV=production

WORKDIR /app/packages/backend

RUN npm ci

RUN npm run build

EXPOSE 3000

CMD [ "npm", "start" ]

ENV GIT_COMMIT=${GIT_COMMIT}